<!DOCTYPE html>
<html>
<head>
  <title>Windmill Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background: #f0f0f0;
    }
    img.logo {
      max-width: 200px;
      display: block;
      margin: 0 auto 10px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .btn {
      display: inline-block;
      margin: 10px;
      padding: 15px 30px;
      font-size: 1.2em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
    }
    #scan-in { background-color: #0077cc; }
    #scan-out { background-color: #cc3300; }
    #reader { width: 100%; max-width: 400px; margin: 20px auto; }
    #success-screen {
      display: none;
      padding: 20px;
    }
    #status { font-weight: bold; margin-top: 20px; }
  </style>
</head>
<body>
  <img class="logo" src="https://github.com/WindmillTheatre/windmill-checkin/raw/main/windmill_blue.png" alt="Windmill Theatre">
  <img class="logo" src="https://github.com/WindmillTheatre/windmill-checkin/raw/main/google%20form%20image.png" alt="Mamma Mia">

  <div id="welcome-screen">
    <h1>Welcome to Windmill Check-In</h1>
    <p>Tap a button to begin:</p>
    <button class="btn" id="scan-in">Sign In</button>
    <button class="btn" id="scan-out">Sign Out</button>
  </div>

  <div id="reader" style="display:none;"></div>
  <div id="success-screen">
    <img class="logo" src="https://github.com/WindmillTheatre/windmill-checkin/raw/main/windmill_blue.png" alt="Windmill Theatre">
    <img class="logo" src="https://github.com/WindmillTheatre/windmill-checkin/raw/main/google%20form%20image.png" alt="Mamma Mia">
    <p id="success-message"></p>
  </div>

  <script>
    let currentAction = "";
    const reader = new Html5Qrcode("reader");

    function startScanner(action) {
      currentAction = action;
      document.getElementById("welcome-screen").style.display = "none";
      document.getElementById("reader").style.display = "block";
      reader.start(
        { facingMode: "user" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          reader.stop();
          document.getElementById("reader").style.display = "none";
          fetch("https://script.google.com/macros/s/AKfycbxVSn6O9nOHNs_eTbdFcPQMtZgtysP0X8CgBlpwkFshGrn6irALgi8oUpg9JNxKHdF36g/exec", {
            method: "POST",
            body: JSON.stringify({
              qrCode: qrCodeMessage,
              action: currentAction,
              name: ""
            }),
            headers: { "Content-Type": "application/json" }
          })
          .then(res => res.text())
          .then(response => {
            const parts = response.split(',');
            const name = parts[0] || "";
            const department = parts[1] || "";
            const time = new Date().toLocaleTimeString();
            document.getElementById("success-message").innerText = `${name} from ${department} has successfully signed ${currentAction.toLowerCase()} at ${time}`;
            document.getElementById("success-screen").style.display = "block";
            setTimeout(() => {
              document.getElementById("success-screen").style.display = "none";
              document.getElementById("welcome-screen").style.display = "block";
            }, 3000);
          })
          .catch(err => {
            document.getElementById("success-message").innerText = "Error: " + err;
            document.getElementById("success-screen").style.display = "block";
            setTimeout(() => {
              document.getElementById("success-screen").style.display = "none";
              document.getElementById("welcome-screen").style.display = "block";
            }, 3000);
          });
        },
        error => {}
      ).catch(err => {
        document.getElementById("status").innerText = "Camera error: " + err;
      });
    }

    document.getElementById("scan-in").onclick = () => startScanner("In");
    document.getElementById("scan-out").onclick = () => startScanner("Out");
  </script>
</body>
</html>
